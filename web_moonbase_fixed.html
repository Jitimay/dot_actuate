<!DOCTYPE html>
<html>
<head>
    <title>Polka-RA Control</title>
    <meta charset="UTF-8">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: rgba(255,255,255,0.95); 
            padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        h1 { 
            text-align: center; 
            color: #2c3e50; 
            margin-bottom: 30px; 
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        button { 
            padding: 20px 30px; 
            font-size: 18px; 
            font-weight: 600;
            border: none; 
            border-radius: 15px; 
            cursor: pointer; 
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-connect { 
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            box-shadow: 0 8px 20px rgba(255,107,107,0.3);
        }
        .btn-network { 
            background: linear-gradient(45deg, #feca57, #ff9ff3);
            color: white;
            box-shadow: 0 8px 20px rgba(254,202,87,0.3);
        }
        .btn-pump { 
            background: linear-gradient(45deg, #48cae4, #0077b6);
            color: white;
            box-shadow: 0 8px 20px rgba(72,202,228,0.3);
        }
        .btn-lamp { 
            background: linear-gradient(45deg, #ffd60a, #f77f00);
            color: white;
            box-shadow: 0 8px 20px rgba(255,214,10,0.3);
        }
        .btn-servo { 
            background: linear-gradient(45deg, #7209b7, #560bad);
            color: white;
            box-shadow: 0 8px 20px rgba(114,9,183,0.3);
        }
        button:hover { 
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.2);
        }
        button:disabled { 
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #status { 
            margin: 30px 0; 
            padding: 20px; 
            background: linear-gradient(45deg, #e8f5e8, #f0f8ff);
            border-radius: 15px;
            border-left: 5px solid #27ae60;
            font-size: 16px;
            font-weight: 500;
        }
        .network-info { 
            background: linear-gradient(45deg, #fff3cd, #ffeaa7);
            padding: 20px; 
            border-radius: 15px; 
            margin: 20px 0;
            border-left: 5px solid #fdcb6e;
        }
        .camera-section {
            margin-top: 40px;
            padding: 30px;
            background: rgba(255,255,255,0.8);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .camera-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        .camera-feed {
            width: 100%;
            max-width: 100%;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .camera-controls {
            text-align: center;
            margin: 20px 0;
        }
        .camera-controls button {
            background: linear-gradient(45deg, #00b894, #00cec9);
            margin: 0 10px;
        }
        .camera-status {
            text-align: center;
            font-style: italic;
            color: #636e72;
            margin-top: 15px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        .status-connected { background: #00b894; }
        .status-disconnected { background: #e17055; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .feature-card {
            background: rgba(255,255,255,0.9);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .feature-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Polka-RA Control Hub</h1>
        
        <div class="feature-grid">
            <div class="feature-card">
                <div class="feature-icon">üîó</div>
                <h3>Blockchain Connected</h3>
                <p>Direct integration with Polkadot ecosystem via Moonbase Alpha</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üåê</div>
                <h3>Decentralized Control</h3>
                <p>Trustless automation through smart contracts</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">‚ö°</div>
                <h3>Real-time Response</h3>
                <p>Instant hardware execution via blockchain commands</p>
            </div>
        </div>
        
        <div class="network-info">
            <span class="status-indicator status-disconnected"></span>
            <strong>Network Required:</strong> Moonbase Alpha Testnet<br>
            <small>Chain ID: 1287 | RPC: https://rpc.api.moonbase.moonbeam.network</small>
        </div>
        
        <div id="status">
            <span class="status-indicator status-disconnected"></span>
            Click Connect MetaMask to begin
        </div>
        
        <div class="control-grid">
            <button class="btn-connect" onclick="connectMetaMask()">ü¶ä Connect MetaMask</button>
            <button class="btn-network" onclick="addMoonbaseNetwork()">üåô Add Moonbase Network</button>
        </div>
        
        <div class="control-grid">
            <button class="btn-pump" onclick="sendCommand('ACTIVATE_PUMP')" id="pumpBtn" disabled>
                üíß Water Pump<br><small>Irrigation System</small>
            </button>
            <button class="btn-lamp" onclick="sendCommand('ACTIVATE_LAMP')" id="lampBtn" disabled>
                üí° Grow Lamp<br><small>LED Array</small>
            </button>
            <button class="btn-servo" onclick="sendCommand('ACTIVATE_SERVO')" id="servoBtn" disabled>
                üîß Servo Motor<br><small>Actuator Control</small>
            </button>
        </div>

        <div class="camera-section">
            <h2>üì∏ Live Camera Feed & Control</h2>
            <div class="camera-live-feed">
                <h3>üî¥ Live Stream</h3>
                <img id="cameraFeed" class="camera-feed" src="http://<YOUR_ESP32_CAM_IP_ADDRESS>/stream" onerror="this.onerror=null;this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkNhbWVyYSBPZmZsaW5lPC90ZXh0Pjwvc3ZnPg==';" alt="ESP32-CAM Live Stream">
                <p class="camera-status">üì° Ensure ESP32-CAM is powered and connected to WiFi</p>
            </div>
            <div class="camera-controls">
                <button onclick="capturePhoto()">üì∑ Capture Photo</button>
                <button onclick="updateStillImage()">üîÑ Refresh Feed</button>
                <p id="cameraStatus" class="camera-status"></p>
            </div>
            <div class="captured-photo">
                <h3>üì∏ Last Captured Photo</h3>
                <img id="stillImage" class="camera-feed" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIFBob3RvIENhcHR1cmVkPC90ZXh0Pjwvc3ZnPg==" alt="Last Captured Photo">
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@polkadot/api@latest/bundle-polkadot-api.js"></script>
    <script src="https://unpkg.com/@polkadot/extension-dapp@latest/bundle-polkadot-extension-dapp.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        let provider = null;
        let signer = null;
        let polkadotApi = null;
        const MOONBASE_CHAIN_ID = '0x507'; // 1287 in hex
        const CONTRACT_ADDRESS = "0x6e2ec30DD6093f247023019e408E226a345e5769";

        async function addMoonbaseNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: MOONBASE_CHAIN_ID,
                        chainName: 'Moonbase Alpha',
                        nativeCurrency: {
                            name: 'DEV',
                            symbol: 'DEV',
                            decimals: 18
                        },
                        rpcUrls: ['https://rpc.api.moonbase.moonbeam.network'],
                        blockExplorerUrls: ['https://moonbase.moonscan.io/']
                    }]
                });
                document.getElementById('status').innerHTML = '<span class="status-indicator status-connected"></span>‚úÖ Moonbase Alpha network added!';
            } catch (error) {
                document.getElementById('status').innerHTML = '‚ùå Failed to add network: ' + error.message;
            }
        }

        async function connectMetaMask() {
            try {
                // Initialize Polkadot API for SDK compliance
                if (window.polkadotApi && window.polkadotApi.ApiPromise) {
                    try {
                        const { ApiPromise, WsProvider } = window.polkadotApi;
                        const wsProvider = new WsProvider('wss://moonbase-alpha.blastapi.io/ws');
                        polkadotApi = await ApiPromise.create({ provider: wsProvider });
                        console.log('‚úÖ Polkadot SDK connected');
                    } catch (polkadotError) {
                        console.log('‚ö†Ô∏è Polkadot SDK optional - continuing without it');
                    }
                }
                
                if (!window.ethereum) {
                    document.getElementById('status').innerHTML = '‚ùå Please install MetaMask and refresh page';
                    return;
                }
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                
                // Check if we're on the right network
                const network = await provider.getNetwork();
                if (network.chainId !== 1287) {
                    document.getElementById('status').innerHTML = '‚ö†Ô∏è Please switch to Moonbase Alpha network (Chain ID: 1287)';
                    return;
                }
                
                signer = provider.getSigner();
                const address = await signer.getAddress();
                
                // Enable buttons
                document.getElementById('pumpBtn').disabled = false;
                document.getElementById('lampBtn').disabled = false;
                document.getElementById('servoBtn').disabled = false;
                
                document.getElementById('status').innerHTML = '<span class="status-indicator status-connected"></span>‚úÖ Connected to Moonbase Alpha: ' + address.substring(0,10) + '...';
                
            } catch (error) {
                document.getElementById('status').innerHTML = '‚ùå Connection failed: ' + error.message;
            }
        }

        async function sendCommand(cmd) {
            if (!signer) {
                document.getElementById('status').innerHTML = '‚ùå Connect MetaMask first';
                return;
            }

            try {
                // Verify Polkadot SDK connection
                if (polkadotApi && polkadotApi.rpc) {
                    const blockHash = await polkadotApi.rpc.chain.getBlockHash();
                    console.log('üì¶ Polkadot SDK - Current block:', blockHash.toString());
                }

                // Check network again before sending
                const network = await provider.getNetwork();
                if (network.chainId !== 1287) {
                    document.getElementById('status').innerHTML = '‚ùå Wrong network! Please switch to Moonbase Alpha';
                    return;
                }

                const abi = ["function setCommand(string memory newCommand) public"];
                const contract = new ethers.Contract(CONTRACT_ADDRESS, abi, signer);
                
                document.getElementById('status').innerHTML = '‚è≥ Sending ' + cmd + ' via Polkadot SDK...';
                
                // Estimate gas first
                const gasEstimate = await contract.estimateGas.setCommand(cmd);
                
                const tx = await contract.setCommand(cmd, {
                    gasLimit: gasEstimate.mul(120).div(100) // Add 20% buffer
                });
                
                document.getElementById('status').innerHTML = '‚è≥ Transaction sent via Polkadot ecosystem...';
                await tx.wait();
                
                document.getElementById('status').innerHTML = '‚úÖ Command sent via Polkadot SDK! ESP32 will execute in ~10 seconds. TX: ' + tx.hash.substring(0,10) + '...';
                
            } catch (error) {
                console.error('Transaction error:', error);
                document.getElementById('status').innerHTML = '‚ùå Error: ' + error.message;
            }
        }

        // Auto-connect if already connected
        window.addEventListener('load', async () => {
            if (window.ethereum && window.ethereum.selectedAddress) {
                connectMetaMask();
            }
        });

        // Listen for network changes
        if (window.ethereum) {
            window.ethereum.on('chainChanged', (chainId) => {
                window.location.reload();
            });
        }

        // --- ESP32-CAM Integration ---
        const ESP32_CAM_IP_ADDRESS = "http://<YOUR_ESP32_CAM_IP_ADDRESS>"; // !!! IMPORTANT: REPLACE WITH YOUR ESP32-CAM'S ACTUAL IP ADDRESS !!!

        async function capturePhoto() {
            document.getElementById('cameraStatus').innerHTML = 'üì∏ Capturing photo...';
            try {
                const response = await fetch(`${ESP32_CAM_IP_ADDRESS}/capture`);
                if (response.ok) {
                    document.getElementById('cameraStatus').innerHTML = '‚úÖ Photo captured!';
                    // Give the camera a moment to save the image, then update
                    setTimeout(updateStillImage, 1000); 
                } else {
                    document.getElementById('cameraStatus').innerHTML = '‚ùå Failed to capture photo.';
                }
            } catch (error) {
                document.getElementById('cameraStatus').innerHTML = '‚ùå Error capturing photo: ' + error.message;
                console.error('Error capturing photo:', error);
            }
        }

        function updateStillImage() {
            const stillImgElement = document.getElementById('stillImage');
            // Append a timestamp to bypass browser caching
            stillImgElement.src = `${ESP32_CAM_IP_ADDRESS}/still.jpg?_t=${new Date().getTime()}`;
        }

        // Initial update for the still image when page loads
        window.addEventListener('load', updateStillImage);
    </script>
</body>
</html>